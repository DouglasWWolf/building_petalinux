<!DOCTYPE html>
<!-- saved from url=(0093)https://rochewiki.roche.com/confluence/plugins/viewsource/viewpagesrc.action?pageId=652453115 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>View Source</title>
        <link rel="canonical" href="https://rochewiki.roche.com/confluence/pages/viewpage.action?pageId=$action.page.id">
        <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\u0022\u005C/confluence\u0022";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script>
<link type="text/css" rel="stylesheet" href="./building_petalinux_files/batch.css" data-wrm-key="_super,-_sync" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="./building_petalinux_files/batch(1).css" data-wrm-key="plugin.viewsource,-_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="./building_petalinux_files/batch(2).css" data-wrm-key="page,-_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="./building_petalinux_files/batch(3).css" data-wrm-key="editor-content,-_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="./building_petalinux_files/custom.css" media="all">

    </head>

    <body class="mceContentBody aui-theme-default wiki-content fullsize">
        <p>&nbsp;</p>         <p><img class="editor-inline-macro" src="./building_petalinux_files/macro" data-macro-name="toc" data-macro-id="84d7c0ad-d88b-4478-9aca-c23a177fdb4e" data-macro-schema-version="1"></p><h1>Introduction</h1><p><strong>These instructions are for Vivado/PetaLinux version 2021.1</strong></p><p><strong><span style="color: rgb(34,34,34);">It is recommended that you have at least 60GB of free storage and 32 GB of RAM before attempting a PetaLinux build.</span></strong></p><p>This document assumes you have a working knowledge of Linux.&nbsp; &nbsp;For the relevant Xilinx documentation, see Xilinx document UG1144 "PetaLinux Tools Documentation Reference Guide".</p><p>While the PetaLinux build tools require Linux, they run just fine on an Ubuntu virtual machine running in a VM on Windows.</p><p>These instructions have been tested on a fresh install of:</p><ul><li>Ubuntu 18.04 Desktop</li><li>Ubuntu 20.04 Desktop</li></ul><p>At the time of this writing, attempting to build PetaLinux on Ubuntu 22.04 is known to fail with an error that looks like:</p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>./../m4-1.4.18/lib/c-stack.c:55:26: error: missing binary operator before token "("</pre></td></tr></tbody></table><p><span style="color: rgb(34,34,34);">As of today (September 1st, 2022), the Petalinux 2021.1 build tools are incompatible with the version of glibc that is used in Ubuntu 22.04, and PetaLinux will not be able to build on that system until Xilinx fixes it.</span></p><h1>A Personal Note to Engineers</h1><p>The Yocto build system (which is at the core of the PetaLinux build tools) has a well deserved reputation for mysterious crashes, spurious errors, hanging without an error message, incomprehensible streams of error messages, etc.&nbsp; If you're an engineer reading this document because you've been tasked with building PetaLinux, and you have any trepidation because of prior encounters with Yocto builds, let this be a note of assurance: this author, during the writing of this document, performed many dozens of Yocto PetaLinux builds and encountered all of the mysterious hangs, crashes, and error streams that Yocto is famous for.&nbsp; &nbsp;What makes this document worth your time to follow is that I ran down the root cause of each and every one of those problems, found the fix (buggy utility, missing library, missing software package, incompatible host OS, etc), and have included the fix in this document.&nbsp; &nbsp;Using these instructions, I have built PetaLinux multiple times on two different Ubuntu versions (18.04 and 20.04) with no errors, crashes, hangs, or any other improper behaviors.<br><br>If you follow these instructions to the letter, it really will build this time, I promise.</p><h1>Required Hardware</h1><p><span style="color: rgb(34,34,34);">You will need:</span></p><ul><li>A Sidewinder</li><li>An SD card with at least 16 GB capacity</li><li>A USB SD card reader</li><li>A micro-USB to USB-C serial cable</li></ul><h1>Xilinx.com Account</h1><p>Before proceeding, create a free account at Xilinx.com.&nbsp; &nbsp;You will need it to download the PetaLinux build tools.</p><h1>Prerequisites and Dependencies</h1><p>The following packages must be installed.&nbsp; This list contains all the packages that Xilinx mentions in their PetaLinux documentation, plus several that they missed:</p><table class="wrapped confluenceTable"><colgroup><col><col></colgroup><tbody><tr><th scope="col" class="confluenceTh">Dependency</th><th scope="col" class="confluenceTh">Installation command</th></tr><tr><th scope="col" class="confluenceTh">OS up to date</th><th scope="col" class="confluenceTh"><pre>sudo apt update</pre></th></tr><tr><th scope="col" class="confluenceTh">gawk</th><th scope="col" class="confluenceTh"><pre>sudo apt install gawk</pre></th></tr><tr><th scope="col" class="confluenceTh">gcc (etc)</th><th scope="col" class="confluenceTh"><pre>sudo apt install build-essential</pre></th></tr><tr><th scope="col" class="confluenceTh">xterm</th><th scope="col" class="confluenceTh"><pre>sudo apt install xterm</pre></th></tr><tr><th scope="col" class="confluenceTh">autoconf</th><th scope="col" class="confluenceTh"><pre>sudo apt install autoconf</pre></th></tr><tr><th scope="col" class="confluenceTh">libtool</th><th scope="col" class="confluenceTh"><pre>sudo apt install libtool</pre></th></tr><tr><th scope="col" class="confluenceTh">texinfo</th><th scope="col" class="confluenceTh"><pre>sudo apt install texinfo</pre></th></tr><tr><th scope="col" class="confluenceTh">zlib1g-dev</th><th scope="col" class="confluenceTh"><pre>sudo apt install zlib1g-dev</pre></th></tr><tr><th scope="col" class="confluenceTh">multilib</th><th scope="col" class="confluenceTh"><pre>sudo apt install gcc-multilib</pre></th></tr><tr><th scope="col" class="confluenceTh">ncurses</th><th scope="col" class="confluenceTh"><pre>sudo apt install libncurses5-dev libncursesw5-dev</pre></th></tr><tr><th scope="col" class="confluenceTh">zlib1g:i386</th><th scope="col" class="confluenceTh"><pre>sudo apt install zlib1g:i386</pre></th></tr><tr><th scope="col" class="confluenceTh">libgtk2.0</th><th scope="col" class="confluenceTh"><pre>sudo apt install libgtk2.0-dev</pre></th></tr><tr><th scope="col" class="confluenceTh">libtinfo5</th><th scope="col" class="confluenceTh"><pre>sudo apt install libtinfo5</pre></th></tr><tr><th scope="col" class="confluenceTh">netstat</th><th scope="col" class="confluenceTh"><pre>sudo apt install net-tools</pre></th></tr></tbody></table><p><br></p><p>If you would like to install those packages with a script instead of manually installing them one at a time, the script is provided below:</p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>sudo apt -y update<br>sudo apt -y install gawk<br>sudo apt -y install build-essential<br>sudo apt -y install xterm<br>sudo apt -y install autoconf<br>sudo apt -y install libtool<br>sudo apt -y install texinfo<br>sudo apt -y install zlib1g-dev<br>sudo apt -y install gcc-multilib<br>sudo apt -y install libncurses5-dev libncursesw5-dev<br>sudo apt -y install zlib1g:i386<br>sudo apt -y install libgtk2.0-dev<br>sudo apt -y install libtinfo5<br>sudo apt -y install net-tools</pre></td></tr></tbody></table><p><br></p><p>If you intend to download git repositories, it is highly recommended that you install the popular 'git' command-line tool:</p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>sudo apt install git</pre></td></tr></tbody></table><h1>Fixing The Broken m4 Utility</h1><p><span style="color: rgb(34,34,34);">Find out what version of the m4 utility is on your system:</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>m4 --version</pre></td></tr></tbody></table><p><span style="color: rgb(34,34,34);">If it's 1.4.18 or below, it's broken.</span></p><p><span style="color: rgb(34,34,34);">Replace the bugged 1.4.18 version of m4 with version 1.4.19:</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>cd ~<br>wget&nbsp;<a href="https://ftp.gnu.org/gnu/m4/m4-1.4.19.tar.gz">ftp.gnu.org/gnu/m4/m4-1.4.19.tar.gz</a><br>tar -xvzf m4-1.4.19.tar.gz<br>cd m4-1.4.19<br>./configure --prefix=/usr<br>make<br>sudo make install</pre></td></tr></tbody></table><h1>Configuring /bin/sh</h1><p><span style="color: rgb(34,34,34);">PetaLinux tools require that your host system /bin/sh is 'bash'. Check this with:</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>ls -l /bin/sh</pre></td></tr></tbody></table><p><span style="color: rgb(34,34,34);">If the result shows that /bin/sh is linked to 'dash', you must change is to 'bash':</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>sudo dpkg-reconfigure dash</pre></td></tr></tbody></table><p><span style="color: rgb(34,34,34);">A menu will pop up asking if you would like to "Use dash as the system default shell".</span><br><span style="color: rgb(34,34,34);">Select "No" and hit &lt;ENTER&gt;</span></p><p><span style="color: rgb(34,34,34);">Confirm that /bin/sh is now linked to 'bash' instead of 'dash':</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>ls -l /bin/sh</pre></td></tr></tbody></table><h1><span style="color: rgb(34,34,34);">Serial Terminal Software</span></h1><p><span style="color: rgb(34,34,34);">The first time you boot PetaLinux you will want to connect to it via a serial terminal.&nbsp; &nbsp;If you will be connecting to the PetaLinux console from a Windows machine, the "putty" serial terminal is free and highly recommended.&nbsp; You can download it here:<br></span></p><p style="text-align: center;"><span style="color: rgb(34,34,34);"><a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html">https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html</a></span></p><p><span style="color: rgb(34,34,34);">If you will be connecting to the PetaLinux console from Linux, "minicom" terminal software is free and highly recommended:</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>sudo apt install minicom</pre></td></tr></tbody></table><p>The serial port configuration is the standard 115200 baud, at 8/N/1.&nbsp; &nbsp; <strong>Ensure that hardware flow control is disabled.</strong>&nbsp; &nbsp;If you forget to disable hardware flow control, the symptom will be that you receive output from PetaLinux as expected, but PetaLinux neither receives nor responds to any character you type.&nbsp; In minicom you can find and change the appropriate settings by:</p><ol><li>Connect a USB serial cable between your Linux PC and the Sidewinder.&nbsp; The Sidewinder can be powered off.</li><li>Running minicom like this: mincom -D /dev/ttyUSB0</li><li>Press 'ctrl-A', then 'o', then select 'Serial Port Setup'</li><li>Select 'E' and changes the settings to 115200 baud, 8/N/1</li><li>Select 'F' and turn off "Hardware Flow Control"</li><li>Press &lt;escape&gt; to get out of the menu</li><li>Select "Save setup as dfl" (i.e, save setup as default) and press &lt;enter&gt;</li></ol><p><span style="color: rgb(34,34,34);">Familiarize yourself with the serial terminal software of your choosing before proceeding.</span></p><h1><span style="color: rgb(34,34,34);">Access to Ubuntu USB Serial Ports</span></h1><p><span style="color: rgb(34,34,34);">When accessing the PetaLinux serial console on a Sidewinder, you will (at least initially) be doing so over a USB serial port, most likely with the device name '/dev/ttyUSB0'<br><br>To avoid difficulties, two configuration changes are recommended.<br><br>First, to avoid spurious locks being places on the serial port:<br></span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>sudo apt-get purge modemmanager</pre></td></tr></tbody></table><p><span style="color: rgb(34,34,34);">Second, your username must be be added to the 'dialout' group:</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>sudo usermod -a -G dialout $USER</pre></td></tr></tbody></table><p>Due to a bug in Ubuntu, it is <u>highly advised</u> to perform a full system reboot after adding your username to the dialout group.&nbsp; It is not enough to simply log-out, and log-back in: a full power-off/power-on power cycle (or system reset) is advised.</p><h1>Installing PetaLinux Build Tools</h1><p>In order to generate a PetaLinux build you will (of course) need to have the PetaLinux build tools installed.<br><br><span style="color: rgb(34,34,34);">Download the "Petalinux Tools - Installer 2021.1" from the link below. &nbsp;</span><br><br><a href="https://www.xilinx.com/downloadNav/embedded-design-tools/2021-1.html">https://www.xilinx.com/downloadNav/embedded-design-tools/2021-1.html</a><br><br><span style="color: rgb(34,34,34);">You should end up with a file called "petalinux-v2021.1-final-insta</span><span style="color: rgb(34,34,34);">ller.run" in your '~/Downloads' folder</span></p><p><span style="color: rgb(34,34,34);">Open a bash terminal, and change to the Downloads directory:<br></span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>cd ~/Downloads</pre></td></tr></tbody></table><p><br></p><p><span style="color: rgb(34,34,34);">Enable execute permission for the installer with:</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>chmod 755 petalinux-v2021.1-final-installer.run</pre></td></tr></tbody></table><p><br></p><p><span style="color: rgb(34,34,34);">Create the installation directory with one of these two commands (this example will use the former):</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>sudo mkdir /opt/petalinux_2021.1</pre></td></tr></tbody></table><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;— or —</p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>sudo mkdir /opt/petalinux/2021.1</pre></td></tr></tbody></table><p><br></p><p><br></p><p><span style="color: rgb(34,34,34);">It's import that the installation directory isn't owned by root, so:</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>sudo chown $USER /opt/petalinux_2021.1<br>sudo chgrp $USER /opt/petalinux_2021.1</pre></td></tr></tbody></table><p><br></p><p><span style="color: rgb(34,34,34);">Install the Petalinux build tools in /opt/petalinux_2021.1 with:</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>./petalinux-v2021.1-final-installer.run -d /opt/petalinux_2021.1</pre></td></tr></tbody></table><p><span style="color: rgb(34,34,34);">That command <strong>must not</strong> be run with sudo or as the root user</span></p><p><span style="color: rgb(34,34,34);">During the install process, accept all of the license agreements.<br>Pressing 'q' closes a license agreement window.<br>Ignore the warning regarding "No tftp server found"<br><br>Upon a successful completion you should see the message "INFO: PetaLinux SDK has been installed to /opt/petalinux_2021.1."<br></span></p><h1><span style="color: rgb(34,34,34);">Obtaining Required Input Files</span></h1><p><span style="color: rgb(34,34,34);">Please read this section in full before proceeding.<br><br>First create a directory to serve as a location for your Petalinux build.&nbsp; For this example, we're going to use '~/peta' as the build folder, so:<br></span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>mkdir ~/peta<br>cd ~/peta</pre></td></tr></tbody></table><p><br></p><p><span style="color: rgb(34,34,34);">To create a PetaLinux build for the Fidus Sidewinder, you will need:</span><br><br><span style="color: rgb(34,34,34);">&nbsp; (1) The Sidewinder board support package 'sidewinder-petalinux-2021.1.bsp'</span><br><span style="color: rgb(34,34,34);">&nbsp; (2) A hardware definition file, typically ending in '.xsa'</span><br><br><span style="color: rgb(34,34,34);">In Vivado, to export a hardware definition file for a given design, select menu item "File", then "Export", then "Export Hardware".</span><br><span style="color: rgb(34,34,34);">When offered the choice between "Pre-Synthesis" or "Include Bitstream", select "Include Bitstream".</span></p><p><span style="color: rgb(34,34,34);"><span style="color: rgb(34,34,34);">You can find both the BSP (Board Support Package) and an example hardware definition (i.e., a .xsa) at:</span></span></p><p><span style="color: rgb(34,34,34);"><span style="color: rgb(34,34,34);"><a href="https://ghe-rss.roche.com/wolfd16/petalinux_sidewinder_files">https://ghe-rss.roche.com/wolfd16/petalinux_sidewinder_files</a><br></span></span></p><p><span style="color: rgb(34,34,34);">The example '.xsa' hardware definition file was exported from this Vivado design:</span></p><p><span style="color: rgb(34,34,34);"><a href="https://ghe-rss.roche.com/wolfd16/qsfp_ddr_exp">https://ghe-rss.roche.com/wolfd16/qsfp_ddr_exp</a></span></p><p><span style="color: rgb(34,34,34);">Your current directory should be '~/peta' (or whatever you chose for a build folder).<br></span></p><p><span style="color: rgb(34,34,34);">Download the BSP file and the example hardware design with:<br></span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>git clone <a href="https://ghe-rss.roche.com/wolfd16/petalinux_sidewinder_files">https://ghe-rss.roche.com/wolfd16/petalinux_sidewinder_files</a></pre></td></tr></tbody></table><p><span style="color: rgb(34,34,34);"><br>The '.bsp' and '.xsa' file are now in folder "~/peta/petalinux_sidewinder_files".<br>Let's move them to our build folder:</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>mv petalinux_sidewinder_files/sidewinder_petalinux_2021.bsp .<br>mv petalinux_sidewinder_files/qsfp_ddr_top.xsa .</pre></td></tr></tbody></table><p><br></p><p><span style="color: rgb(34,34,34);">At this point, the '.bsp' and the '.xsa' should be in your build folder, so we can get rid of the cloned repository:</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>rm -rf petalinux_sidewinder_files</pre></td></tr></tbody></table><h1>Creating the PetaLinux Project</h1><p><span style="color: rgb(34,34,34);">Before we use the PetaLinux tools (and any time we want to use the PetaLinux tools), we have to set up the path:</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>source /opt/petalinux_2021.1/settings.sh</pre></td></tr></tbody></table><p><span style="color: rgb(34,34,34);">When you execute that command, ignore the warning "WARNING: This is not a supported OS"</span><br><span style="color: rgb(34,34,34);">Also ignore "WARNING: no tftp server found"</span><br><br><span style="color: rgb(34,34,34);">You should still be in the "~/peta" directory that you've chosen as your build folder.</span></p><p><span style="color: rgb(34,34,34);">Create the PetaLinux project from the provided BSP in a subdirectory named 'system':<br></span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>petalinux-create -t project -s <a href="http://sidewinder-petalinux-2021.1.bs/">sidewinder-petalinux-2021.1.bs</a>p -n system</pre></td></tr></tbody></table><p><span style="color: rgb(34,34,34);"><br>Change the current directory to the folder that PetaLinux considers its root folder for the build:<br></span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>cd system</pre></td></tr></tbody></table><p><span style="color: rgb(34,34,34);"><br>Now we'll generate the Kconfig file from the hardware description:<br></span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>petalinux-config --get-hw-description ../qsfp_ddr_top.xsa</pre></td></tr></tbody></table><p><span style="color: rgb(34,34,34);"><br>The 'petalinux-config' command should leave you in a configuration menu.<br>For the moment, we'll use all default settings, so simply choose 'exit'.<br>Answer "Yes" if asked whether to save the new configuration.<br></span></p><h1><span style="color: rgb(34,34,34);">Optional: Including GCC in the PetaLinux build</span></h1><p><span style="color: rgb(34,34,34);">If you need to be able to compile C/C++ source code on the target board (for example, to compile Fidus's QSFP28 demonstration software) , you will need gcc installed as part of your PetaLinux build:</span></p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>petalinux-config -c rootfs</pre></td></tr></tbody></table><p><br></p><p><span style="color: rgb(34,34,34);">When the configuration menu is displayed:<br><br></span></p><ol><li><span style="color: rgb(34,34,34);">Select "Filesystem Packages"</span></li><li><span style="color: rgb(34,34,34);">Then select "misc"</span></li><li><span style="color: rgb(34,34,34);">Then select "packgroup-core-buildessential"</span></li><li><span style="color: rgb(34,34,34);">Enable "packagegroup-core-buildessential" and "packagegroup-core-buildessential-dev"</span></li><li><span style="color: rgb(34,34,34);">Select "Exit" to get to the previous menu</span></li><li><span style="color: rgb(34,34,34);">Then select "gcc-runtime"</span></li><li><span style="color: rgb(34,34,34);">Enable both "libstdc++" and "libstdc++-dev"<br></span></li><li><span style="color: rgb(34,34,34);">Exit all the way out of the menu system, not forgetting to choose "save" when asked.</span></li></ol><p><br></p><h1><span style="color: rgb(34,34,34);">Performing the Build</span></h1><p>Now we're finally ready to perform the build.&nbsp; The current directory should be the build directory, which in our example is "~/peta/system".</p><p><br>Run the Yocto build for PetaLinux:</p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>petalinux-build</pre></td></tr></tbody></table><p><span style="color: rgb(34,34,34);">Ignore any warning like "WARNING: Host distribution has not been validated with this version..."<br>Be aware that the build could take an hour or more, depending on the speed of your computer and your internet connection.<br></span></p><p><span style="color: rgb(34,34,34);">If the build process is a success, you will (eventually) see the message "[INFO] Successfully built project"</span></p><h1>Generating the Boot Image</h1><p>After a successful PetaLinux build,&nbsp; you must create the ./images/linux/BOOT.BIN file that contains the bootloader:</p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>petalinux-package --boot --u-boot</pre></td></tr></tbody></table><h1>Formatting an SD Card</h1><p>In order to boot your new PetaLinux build from an SD card, you will need an SD card that is at least 16GB in size.&nbsp; Prior to copying your build to the SD card, the SD card must be properly formatted.&nbsp; A script to format an SD card appropriately is below.&nbsp; The two blank lines between the "2" and the "w" in the fdisk command are important; don't change them.<br><br>This script assumes the block device that the SD card appears as is "/dev/sdb".&nbsp; You must be <strong>ABSOLUTELY CERTAIN</strong> that /dev/sdb is the appropriate device on your system, or you WILL end up destroying a storage device (like a hard-drive or SSD) that you didn't intend to.&nbsp; If /dev/sdb is not the appropriate device name on your system, change the SD=/dev/&lt;something&gt; line at the top of the script to match your system.</p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>#===========================================================<br># make_petalinux_sd.sh<br>#<br># A utility for creating SD cards suitable for storing<br># a Petalinux build<br>#<br># Author: Doug Wolf<br>#===========================================================<br><br>#&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&gt;&lt;&gt;&lt;&gt;<br>#&nbsp;&nbsp;&nbsp; YOU MUST(!!) CHANGE THIS TO BE THE CORRECT DEVICE!<br>#&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&gt;&lt;&gt;&lt;&gt;<br>SD=/dev/sdb<br>#&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&gt;&lt;&gt;&lt;&gt;<br><br># Make sure the SD card device actually exists!<br>if [ ! -b ${SD} ]; then<br> &nbsp;&nbsp; echo "There is no block device called ${SD}"<br> &nbsp; exit 1<br>fi<br><br># Check to ensure we are the root user<br>if [ $(id -u) -ne 0 ]; then<br> &nbsp;&nbsp; echo "Must be run as root.&nbsp; Use sudo."<br> &nbsp;&nbsp; exit 1<br>fi<br><br># Make absolutely certain that the SD card isn't mounted<br>umount ${SD}* 2&gt;/dev/null<br><br># Blow away the partition map so the SD card appears empty<br>echo Erasing ${SD}<br>dd if=/dev/zero of=${SD} count=65536 &gt;/dev/null 2&gt;/dev/null<br><br># Create two partitions:<br>#&nbsp; Partition 1 starts at block 2048 and is 1GB in size.<br>#&nbsp; Partition 2 starts after partition 1 and occupies the  <br>#  rest of available space<br>echo "Partitioning ${SD} with fdisk"<br>fdisk ${SD} &gt;/dev/null 2&gt;/dev/null &lt;&lt;EOF<br>n<br>p<br>1<br>2048<br>+1G<br>n<br>p<br>2<br><br><br>w<br>EOF<br><br># Create the file-systems<br>echo "Making FAT file system on ${SD}1"<br>mkfs.vfat ${SD}1 &gt;/dev/null<br><br>echo "Making ext4 file system on ${SD}2"<br>mkfs.ext4 ${SD}2 &gt;/dev/null 2&gt;/dev/null</pre><pre># Tell the user their SD card is ready<br>echo&nbsp; "SD card at ${SD} is formatted and ready"</pre></td></tr></tbody></table><pre><br></pre><h1>Copy PetaLinux to the SD Card</h1><p>After you've completed a PetaLinux build and have properly formatted an SD card according to the instructions in the prior section, you can copy your PetaLinux build to the SD card.&nbsp; &nbsp;Below is a script that will perform that operation for you.<br><br>When you run this script, you should be in one of the top two build directories; in our example build, that means the current directory should be '~/peta' or '~/peta/system'<br><br>After running this script, you will have a bootable SD card.</p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>#====================================================================<br># copy_petalinux_to_sd.sh<br>#<br># Utility to copy a bootable PetaLinux build to a formatted SD card.<br>#<br># Author: Doug Wolf<br>#====================================================================<br><br>#&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;<br># &nbsp;You must change this to be the correct SD card device!<br>#&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;<br>SD=/dev/sdb<br>#&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;<br><br>#&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;<br># &nbsp;You must change this to be an existing mount-point<br>#&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;&lt;&gt;<br>mount_point=/media/$(logname)<br><br># Make sure the SD card device actually exists!<br>if [ ! -b ${SD} ]; then<br>&nbsp; &nbsp; echo "There is no block device called ${SD}"<br>&nbsp; &nbsp;exit 1<br>fi<br><br># Make sure the mount point actually exists!<br>if [ ! -d ${mount_point} ]; then<br>&nbsp; &nbsp; echo "The mount point ${mount_point} does not exist"<br>&nbsp; &nbsp; exit 1<br>fi<br><br># Here, we are just checking to see if we're the root user<br>if [ $(id -u) -ne 0 ]; then<br>&nbsp; &nbsp; echo "Must be run as root. &nbsp;Use sudo."<br>&nbsp; &nbsp; exit 1<br>fi<br><br># Figure out the path to our PetaLinux files<br>path=$(find . | grep linux/image.ub)<br>if [ ! -z ${path} ]; then<br>&nbsp; &nbsp; path=$(dirname ${path})<br>fi<br><br># Ensure that the path exists<br>if [ -z "${path}" ]; then<br>&nbsp; &nbsp; echo "Can't find image.ub. &nbsp;Are you in the right directory?"<br>&nbsp; &nbsp; exit 1<br>fi<br><br># Let's ensure that our SD device isn't mounted anywhere<br>umount ${SD}1 ${SD}2 2&gt;/null<br><br># Now mount the boot partition<br>echo "Mounting boot partition (${SD}1) on ${mount_point}"<br>mount ${SD}1 ${mount_point}<br><br># Make sure that the mount worked<br>if [ $? -ne 0 ]; then<br>&nbsp; &nbsp; echo "Failed to mount ${SD}1 on ${mount_point}!"<br>&nbsp; &nbsp; exit 1<br>fi<br><br># Copy the boot files to the SD card<br>echo "Copying files to boot partition"<br>cp ${path}/BOOT.BIN ${mount_point}<br>cp ${path}/image.ub ${mount_point}<br>cp ${path}/boot.scr ${mount_point}<br><br># Unmount the boot partition<br>echo "Unmounting ${SD}1"<br>umount ${SD}1<br><br># Mount the ext4 partition<br>echo "Mounting root partition(${SD}2) on ${mount_point}"<br>mount ${SD}2 ${mount_point}<br><br># Make sure that the mount worked<br>if [ $? -ne 0 ]; then<br>&nbsp; &nbsp; echo "Failed to mount ${SD}2 on ${mount_point}!"<br>&nbsp; &nbsp; exit 1<br>fi<br><br># Erase whatever is in that filesystem<br>rm -rf ${mount_point}/*<br><br># Untar our root filesystem into the partition<br>echo "Copying root filesystem into partition"<br>tar -xzf ${path}/rootfs.tar.gz -C ${mount_point}<br><br># Unmount the filesystem<br>echo "Unmounting ${SD}2"<br>umount ${SD}2<br><br># All finished!<br>echo "Done!"</pre></td></tr></tbody></table><p><br></p><h1>Booting and Logging in to PetaLinux</h1><p>After you've loaded PetaLinux onto the SD card, remove the SD card from the host PC, and insert it into the SD card slot of a <strong>powered off</strong> Sidewinder.&nbsp; The jumper switches on the Sidewinder must be set to boot from the SD card; to do this:<br><br>(1) Orient the Sidewinder so that the front of the card (with all of the components and heat-sinks) is facing away from you, and the back of the card (with two sets of three push-buttons across the top edge) is facing towards you.<br><br>(2) Along the top edge, between the two sets of push-button switches, is a very small 4-pin DIP switch.&nbsp; &nbsp; It is mounted upside down, so switch #4 is nearest the top, and switch #1 is nearest the bottom.&nbsp; &nbsp; From top to bottom, set the switches like this:</p><table class="wrapped confluenceTable" style="margin-left: auto;margin-right: auto;"><colgroup><col><col></colgroup><tbody><tr><th scope="col" style="text-align: center;" class="confluenceTh">Switch</th><th scope="col" style="text-align: center;" class="confluenceTh">Setting</th></tr><tr><th scope="col" style="text-align: center;" class="confluenceTh">#4</th><th scope="col" style="text-align: center;" class="confluenceTh">Left</th></tr><tr><th scope="col" style="text-align: center;" class="confluenceTh">#3</th><th scope="col" style="text-align: center;" class="confluenceTh">Right</th></tr><tr><th scope="col" style="text-align: center;" class="confluenceTh">#2</th><th scope="col" style="text-align: center;" class="confluenceTh">Left</th></tr><tr><th scope="col" style="text-align: center;" class="confluenceTh">#1</th><th scope="col" style="text-align: center;" class="confluenceTh">Right</th></tr></tbody></table><p style="text-align: left;"><br></p><p style="text-align: left;">You should have already followed the instructions for setting up the serial port that were given earlier in this document.&nbsp; &nbsp;Ensure that the SD card is inserted properly into the Sidewinder, ensure that the USB serial cable is attached between the Sidewinder serial port and your host PC, start your serial terminal software (if it's 'minicom', start it with 'minicom -D /dev/ttyUSB0"), and apply power.<br><br>After a few seconds, you should see Linux boot process.<br><br>When you reach a Linux login prompt, the default Petalinux username and password are both "root".<br><br>Have fun <img class="emoticon emoticon-smile" data-emoticon-name="smile" border="0" src="./building_petalinux_files/smile.svg" alt="(smile)" title="(smile)"><br><br>One last parting shot:&nbsp; try to avoid simply powering-down the Sidewinder with PetaLinux running.&nbsp; &nbsp; It's much safer to give Linux a chance to do an orderly shutdown by issuing this command at the PetaLinux command prompt:</p><table class="wrapped confluenceTable"><colgroup><col></colgroup><tbody><tr><td class="confluenceTd"><pre>sync;sync;shutdown -h now</pre></td></tr></tbody></table><p>Eventually we will figure out how to configure PetaLinux with initramfs, so that the Sidewinder can be arbitrarily powered off without any concern for the filesystem.</p><p><br></p>
        <p>&nbsp;</p>
    

</body></html>